

To support two DNS names for each Tomcat service (i.e., both service1.example.com and service1-alias.example.com for Tomcat Service 1, and service2.example.com and service2-alias.example.com for Tomcat Service 2), the setup should handle multiple DNS names for each service. This allows for flexibility while ensuring that the WSDL binding URL reflects the correct HTTPS DNS name that was called by the client.

Architecture Overview:

	•	HAProxy will handle SSL termination for four DNS names (two for each Tomcat service).
	•	Each Tomcat service will recognize the forwarded X-Forwarded-Proto and X-Forwarded-Host headers to generate the correct WSDL binding URLs based on the DNS name that was used.

Steps:

1. HAProxy Configuration for Multiple DNS Names per Service

You will configure HAProxy to support both DNS names for each service and route requests to the respective Tomcat backend.

	•	File: /etc/haproxy/haproxy.cfg
	•	Key Configuration:

frontend https-in
    bind *:443 ssl crt /etc/haproxy/certs/service1.pem crt /etc/haproxy/certs/service2.pem
    mode http
    
    # Define ACLs to differentiate between DNS names for each service
    acl is_service1_primary hdr(host) -i service1.example.com
    acl is_service1_alias hdr(host) -i service1-alias.example.com
    acl is_service2_primary hdr(host) -i service2.example.com
    acl is_service2_alias hdr(host) -i service2-alias.example.com

    # Route to the appropriate backend based on the DNS name
    use_backend tomcat-service1-backend if is_service1_primary or is_service1_alias
    use_backend tomcat-service2-backend if is_service2_primary or is_service2_alias

    # Add necessary headers for forwarding information
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Host %[hdr(host)]
    option forwardfor

backend tomcat-service1-backend
    server tomcat1 192.168.1.101:8080 check
    http-request set-header Host service1.example.com if is_service1_primary
    http-request set-header Host service1-alias.example.com if is_service1_alias

backend tomcat-service2-backend
    server tomcat2 192.168.1.102:8080 check
    http-request set-header Host service2.example.com if is_service2_primary
    http-request set-header Host service2-alias.example.com if is_service2_alias


	•	Explanation:
	•	Multiple DNS Names: We create access control lists (ACLs) to differentiate between the primary and alias DNS names for each service (service1.example.com and service1-alias.example.com for Service 1, and similarly for Service 2).
	•	Based on the DNS name (Host header), requests are routed to the appropriate backend (either Tomcat Service 1 or Tomcat Service 2).
	•	The X-Forwarded-Proto and X-Forwarded-Host headers are forwarded so that Tomcat can generate the correct URLs in the WSDL.

2. Tomcat Configuration to Recognize Forwarded HTTPS and DNS

For both Tomcat Service 1 and Tomcat Service 2, configure Tomcat to recognize the X-Forwarded-Proto and X-Forwarded-Host headers. This allows Tomcat to generate the WSDL URLs with the correct DNS name.

	•	File: conf/server.xml (Tomcat configuration for each service)
	•	Key Configuration:
Add a RemoteIpValve to both Tomcat servers to handle the forwarded headers.

<Valve className="org.apache.catalina.valves.RemoteIpValve"
       protocolHeader="X-Forwarded-Proto"
       protocolHeaderHttpsValue="https"
       hostHeader="X-Forwarded-Host" />


	•	Explanation:
	•	The RemoteIpValve configuration ensures that Tomcat uses the values from the X-Forwarded-Proto (for HTTPS) and X-Forwarded-Host (for DNS name) headers.
	•	This ensures the WSDL URLs (or any dynamically generated URLs) reflect the correct DNS name and HTTPS protocol, regardless of which alias was used.

3. Axis2 Configuration (if Using Axis2 for SOAP Services)

If you’re using Apache Axis2 for SOAP services, make sure that Axis2 is also aware of the X-Forwarded-Host header so that it can generate WSDLs with the correct DNS name.

	•	File: WEB-INF/conf/axis2.xml (within your Axis2 web application)
	•	Key Configuration:

<transportReceiver name="http"
                   class="org.apache.axis2.transport.http.AxisServletListener">
    <parameter name="http" locked="false">https</parameter>
</transportReceiver>



This will ensure that Axis2 reflects HTTPS in the WSDL URL generation. Additionally, Axis2 can respect the X-Forwarded-Host header to generate WSDLs with the correct DNS name (primary or alias).

4. Verify the Setup

	•	Test access to https://service1.example.com and https://service1-alias.example.com, ensuring that the WSDL generated by Tomcat Service 1 reflects the correct HTTPS URL.
	•	Similarly, test access to https://service2.example.com and https://service2-alias.example.com to verify that Tomcat Service 2 generates WSDLs with the correct binding URLs.

Conclusion:

	•	HAProxy is configured to handle SSL termination for multiple DNS names per service, routing traffic to the correct Tomcat service.
	•	Tomcat uses the X-Forwarded-Proto and X-Forwarded-Host headers to dynamically generate URLs in WSDLs with the correct DNS name and protocol.
	•	Axis2 (if used) also recognizes the forwarded headers to generate the correct binding URLs in the WSDL.

This configuration ensures that both Tomcat services can support multiple DNS names, with WSDLs reflecting the correct HTTPS DNS in which the service is called.


=#=#
To support two different HTTPS DNS names (e.g., service1.example.com and service2.example.com) through HAProxy, and ensure that the WSDLs served by the Tomcat backend reference the correct HTTPS DNS in which the service is called, you can configure HAProxy and Tomcat to properly handle these requests.

Here’s how to set it up:

1. HAProxy Configuration for Multiple HTTPS Domains:

You can configure HAProxy to handle SSL termination for both DNS names and forward the request to Tomcat while ensuring the correct X-Forwarded-Host and X-Forwarded-Proto headers are set. This will allow Tomcat to generate the appropriate WSDL URLs.

	•	File: /etc/haproxy/haproxy.cfg
	•	Key Configuration:

frontend https-in
    bind *:443 ssl crt /etc/haproxy/certs/service1.pem crt /etc/haproxy/certs/service2.pem
    mode http
    acl is_service1 hdr(host) -i service1.example.com
    acl is_service2 hdr(host) -i service2.example.com

    use_backend tomcat-service1-backend if is_service1
    use_backend tomcat-service2-backend if is_service2

    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Host %[hdr(host)]
    option http-server-close
    option forwardfor
    
backend tomcat-service1-backend
    server tomcat1 192.168.1.101:8080 check
    http-request set-header Host service1.example.com

backend tomcat-service2-backend
    server tomcat2 192.168.1.102:8080 check
    http-request set-header Host service2.example.com



In this setup:

	•	Multiple Certificates: HAProxy is configured to handle SSL for both service1.example.com and service2.example.com. You specify the respective certificates (service1.pem and service2.pem).
	•	Host-based Routing: The acl rules check the Host header to determine which service was called and route the traffic to the appropriate backend (tomcat-service1-backend or tomcat-service2-backend).
	•	X-Forwarded Headers: X-Forwarded-Proto is set to https, and X-Forwarded-Host is set to the original DNS hostname. These headers are crucial to ensure that Tomcat knows which hostname and protocol the client used.

2. Tomcat Configuration for Dynamic WSDL URLs:

Tomcat needs to recognize the forwarded headers so that it can generate the correct URLs in the WSDL.

	•	File: conf/server.xml (Tomcat configuration)
	•	Key Configuration:
Add RemoteIpValve to each Tomcat server to handle the forwarded headers from HAProxy.

<Valve className="org.apache.catalina.valves.RemoteIpValve"
       protocolHeader="X-Forwarded-Proto"
       protocolHeaderHttpsValue="https"
       hostHeader="X-Forwarded-Host"
       portHeader="X-Forwarded-Port" />



This configuration tells Tomcat to use the X-Forwarded-Host header for the DNS name and the X-Forwarded-Proto for the protocol (HTTPS), ensuring that the generated WSDL reflects the correct HTTPS URL.

3. Axis2 Configuration (if using Axis2 for SOAP):

If you’re using Axis2 for your web services, you may need to modify Axis2’s WSDL URL generation to reflect the correct HTTPS DNS.

	•	File: WEB-INF/conf/axis2.xml (within your Axis2 web application)
	•	Key Configuration: Ensure that Axis2 generates the correct URLs by making use of the forwarded headers.

<transportReceiver name="http"
                   class="org.apache.axis2.transport.http.AxisServletListener">
    <parameter name="http" locked="false">https</parameter>
</transportReceiver>



Additionally, you can create custom logic or interceptors that adjust the WSDL soap:address to reflect the value in the X-Forwarded-Host header.

Summary:

	•	HAProxy: Handles SSL for both service1.example.com and service2.example.com, routes the requests based on the DNS name, and forwards the X-Forwarded-Proto and X-Forwarded-Host headers.
	•	Tomcat: Configured with RemoteIpValve to recognize the X-Forwarded headers, ensuring that it generates WSDL URLs with the correct HTTPS DNS.
	•	Axis2 (Optional): Modify WSDL generation to ensure it reflects the HTTPS DNS based on the headers.

This setup will allow your Tomcat services to handle requests for multiple HTTPS domains and serve WSDLs with the correct domain in the binding URL.

=#=#
To configure Tomcat to work with an HAProxy load balancer handling HTTPS, without installing certificates on the Tomcat server, you can configure Tomcat to trust the X-Forwarded-Proto header and let HAProxy manage the SSL termination. This will allow Tomcat to generate WSDLs with HTTPS URLs, even though it’s running HTTP internally.

Here are the key files and configurations involved:

1. HAProxy Configuration (SSL Termination):

In HAProxy, you need to ensure SSL termination is correctly set up. This means HAProxy will handle HTTPS connections from clients, forward the requests to Tomcat using HTTP, and add the X-Forwarded-Proto header.

	•	File: /etc/haproxy/haproxy.cfg
	•	Key Configuration:

frontend https-in
    bind *:443 ssl crt /etc/haproxy/certs/yourcert.pem
    option http-server-close
    option forwardfor
    reqadd X-Forwarded-Proto:\ https
    default_backend tomcat-backend

backend tomcat-backend
    server tomcat-server1 192.168.1.100:8080 check



In this configuration:

	•	bind *:443 ssl crt /etc/haproxy/certs/yourcert.pem: Configures SSL termination on HAProxy.
	•	reqadd X-Forwarded-Proto:\ https: Adds the X-Forwarded-Proto header to indicate HTTPS.

2. Tomcat Configuration (Recognizing HTTPS):

Tomcat should be configured to trust the X-Forwarded-Proto header so that it generates URLs with HTTPS in the WSDL files.

	•	File: conf/server.xml (Tomcat configuration)
	•	Key Configuration: Add a RemoteIpValve to recognize the X-Forwarded-Proto header.

<Valve className="org.apache.catalina.valves.RemoteIpValve"
       protocolHeader="X-Forwarded-Proto"
       protocolHeaderHttpsValue="https" />



This tells Tomcat to treat the request as HTTPS when it sees X-Forwarded-Proto: https from the load balancer.

3. Optional Axis2 Configuration:

If you’re using Apache Axis2 for SOAP services, you may need to ensure Axis2 uses the correct scheme in the generated WSDL.

	•	File: WEB-INF/conf/axis2.xml (within your Axis2 web application)
	•	Key Configuration: Make sure you configure the transport receivers to handle HTTPS correctly, or you can manually adjust the service endpoint URLs.

<transportReceiver name="http"
                   class="org.apache.axis2.transport.http.AxisServletListener">
    <parameter name="http" locked="false">https</parameter>
</transportReceiver>



This setup, combined with HAProxy handling SSL, should allow your Tomcat services to expose WSDL with HTTPS URLs, without the need for installing certificates directly on Tomcat.